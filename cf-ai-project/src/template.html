<!--
 --- template.html
 ---
 --- Minimal frontend for AI chat.
 -->

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>AI Chat</title>
    <style>
      body {
        font-family: monospace;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        margin: 0;
        padding: 20px;
      }

      #response {
        width: 60%;
        margin: 20px 0;
        white-space: pre-wrap;
      }

      form { 
        bottom: 20px;
        display: flex;
        width: 60%;
        gap: 10px;
      }

      input { 
        flex: 1;
        padding: 5px;
      }
    </style>
  </head>
  <body>
    <div id="content">
      <div id="header">
        <h1>AI Chat</h1>
      </div>

      <div id="response"></div>

      <form id="query-form">
        <input 
          autofocus
          name="query"
          placeholder="Ask the AI anything" 
          type="text" 
        >
        </input>
        <button type="submit">Ask</button>
      </form>
    </div>

    <script>
      const response = document.getElementById("response")
      const form = document.getElementById("query-form")

      form.addEventListener("submit", async (e) => {
        e.preventDefault()
        response.textContent = ""
        
        // get session ID (or generate new one)
        let session = sessionStorage.getItem("session")
        if (!session) {
          session = Math.random().toString(36).substring(2)
          sessionStorage.setItem("session", session)
        }

        // get query
        const url = `/stream?query=${e.target.query.value}&session=${session}`
        const source = new EventSource(url)

        // get streamed response
        source.onmessage = (event) => {
          if (event.data === "[DONE]") {
            source.close()
            e.target.query.value = ""
            return
          }

          try {
            const data = JSON.parse(event.data)
            if (typeof data.response == "string") {
              document.querySelector("div#response").innerHTML += data.response
            }
          } catch {
            console.error("Invalid data.", event.data)
          }
        }
      })
    </script>
  </body>
</html>